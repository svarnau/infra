includes:
  - python-file: openstack_functions.py

pipelines:
  - name: check
    description: Newly uploaded patchsets enter this pipeline to receive an initial +/-1 Verified vote from Jenkins.
    failure-message: Build failed.  https://wiki.trafodion.org/wiki/index.php/Code_Reviews#Test_Failures
    manager: IndependentPipelineManager
    precedence: low
    trigger:
      gerrit:
        - event: patchset-created
        - event: change-restored
        - event: comment-added
          comment_filter: (?i)^\s*recheck(( (?:bug|lp)[\s#:]*(\d+))|( no bug))\s*$
    success:
      gerrit:
        verified: 1
    failure:
      gerrit:
        verified: -1

  - name: gate
    description: Changes that have been approved by core developers are enqueued in order in this pipeline, and if they pass tests in Jenkins, will be merged.
    failure-message: Build failed.  https://wiki.trafodion.org/wiki/index.php/Code_Reviews#Test_Failures
    manager: DependentPipelineManager
    precedence: low
    trigger:
      gerrit:
        - event: comment-added
          approval:
            - approved: 1
        - event: comment-added
          comment_filter: (?i)^\s*reverify(( (?:bug|lp)[\s#:]*(\d+))|( no bug))\s*$
    start:
      gerrit:
        verified: 0
    success:
      gerrit:
        verified: 2
        submit: true
    failure:
      gerrit:
        verified: -2

#  - name: post
#    description: This pipeline runs jobs that operate after each change is merged.
#    manager: IndependentPipelineManager
#    precedence: low
#    trigger:
#      gerrit:
#        - event: ref-updated
#          ref: ^(?!(devnull|refs/.*)).*$

  - name: pre-release
    description: This pipeline runs jobs on projects in response to pre-release tags.
    manager: IndependentPipelineManager
    precedence: high
    trigger:
      gerrit:
        - event: ref-updated
          ref: ^refs/tags/([0-9]+\.)+[0-9]*(alpha|beta|candidate|rc|a|b|c|r|g)[0-9]*$

  - name: release
    description: When a commit is tagged as a release, this pipeline runs jobs that publish archives and documentation.
    manager: IndependentPipelineManager
    precedence: high
    trigger:
      gerrit:
        - event: ref-updated
          ref: ^refs/tags/([0-9]+\.)+[0-9]+$

  - name: silent
    description: This pipeline is used for silently testing new jobs.
    manager: IndependentPipelineManager
    precedence: low
    trigger:
      gerrit:
        - event: patchset-created
        - event: comment-added
          comment_filter: (?i)^\s*recheck(( (?:bug|lp)[\s#:]*(\d+))|( no bug))\s*$

  - name: experimental
    description: On-demand pipeline for requesting a run against a set of jobs that are not yet gating. Leave review comment of "check experimental" to run jobs in this pipeline.
    manager: IndependentPipelineManager
    precedence: low
    trigger:
      gerrit:
        - event: comment-added
          comment_filter: (?i)^\s*check experimental\s*$
    success:
      gerrit:
        force-message: true
    failure:
      gerrit:
        force-message: true

  - name: daily
    description: Jobs in this queue are triggered daily.
    manager: IndependentPipelineManager
    precedence: low
    trigger:
      timer:
        - time: '30 8 * * *'


jobs:
  - name: ^.*$
    parameter-function: set_log_url
  - name: core-regress-compGeneral
    voting: false
  - name: core-regress-executor
    voting: false
  - name: core-regress-hive
    voting: false
  - name: core-regress-seabase
    voting: false
  - name: phoenix_test
    voting: true
  - name: phoenix_test-experimental
    voting: false
  - name: pyodbc_test
    voting: true
  - name: pyodbc_test-experimental
    voting: false
  - name: gate-infra-puppet-lint
    voting: false

projects:
  - name: trafodion/sandbox
    check:
      - gate-sandbox-check-for-binary
    gate:
      - gate-sandbox-check-for-binary
    silent:
      - gate-sandbox-puppet-lint
      - gate-sandbox-puppet-syntax

  - name: trafodion/core
    check:
      - phoenix_test
      - core-regress-core
      - core-regress-charsets
      - core-regress-compGeneral
      - core-regress-executor
      - core-regress-hive
      - core-regress-qat
      - core-regress-seabase
      - core-regress-udr
      - gate-core-check-for-binary
    gate:
      - phoenix_test
      - core-regress-core
      - core-regress-charsets
      - core-regress-compGeneral
      - core-regress-executor
      - core-regress-hive
      - core-regress-qat
      - core-regress-seabase
      - core-regress-udr
      - gate-core-check-for-binary
    daily:
      - traf-pub-release
      - traf-pub-debug
    release:
      - traf-pub-release
    pre-release:
      - traf-pub-release

  - name: trafodion/dcs
    check:
      - gate-dcs-check-for-binary
      - dcs-build
      - phoenix_test
      - pyodbc_test
      - pyodbc_test-experimental
    gate:
      - gate-dcs-check-for-binary
      - dcs-build
      - phoenix_test
      - pyodbc_test
      - pyodbc_test-experimental

  - name: trafodion/infra
    check:
      - gate-infra-check-for-binary
      - gate-infra-puppet-lint
      - gate-infra-puppet-syntax
    gate:
      - gate-infra-check-for-binary
      - gate-infra-puppet-lint
      - gate-infra-puppet-syntax

  - name: trafodion/manuals
    check:
      - gate-noop
    gate:
      - gate-noop

  - name: trafodion/phoenix_test
    check:
      - gate-phoenix_test-check-for-binary
      - phoenix_test

    gate:
      - gate-phoenix_test-check-for-binary
      - phoenix_test

  - name: trafodion/install
    check:
      - gate-install-check-for-binary
      - installer-build
    gate:
      - gate-install-check-for-binary
      - installer-build

  - name: trafodion/win-odbc64
    check:
      - gate-win-odbc64-check-for-binary
    gate:
      - gate-win-odbc64-check-for-binary

